<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47871740-2', 'auto');
  ga('send', 'pageview');

</script>
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Bharat Kunduri &middot; Personal Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/Bb.png">
                                 <link rel="shortcut icon" href="/public/Bb.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0f">

    <div class="sidebar">
  <div class="container sidebar">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Bharat Kunduri
        </a>
      </h1>
      <p class="lead">A blog I use to share some of my projects and discuss about projects I come across.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <!-- <a class="sidebar-nav-item" href="https://github.com/bharatreddy/archive/v2.1.0.zip">Download</a> -->
      <a class="sidebar-nav-item" href="https://github.com/bharatreddy">GitHub</a>
      <a class="sidebar-nav-item" href="http://www.linkedin.com/pub/bharat-kunduri/64/14a/9a0/">LinkedIn</a>
      <a class="sidebar-nav-item" href="mailto:bharatr@vt.edu">Email</a>
      <!-- <span class="sidebar-nav-item">Currently v2.1.0</span> -->
    </nav>

    <!-- <p>&copy; 2015. All rights reserved.</p> -->
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/01/15/sql-pandas1/">
        Equating SQL and Pandas (Part-1)
      </a>
    </h1>

    <span class="post-date">15 Jan 2015</span>

    <p><a href="http://pandas.pydata.org/">Pandas</a> is a really powerful data analysis library in python created by <a href="http://blog.wesmckinney.com/">Wes McKinney</a>. Pandas provides fast and robust data structures and methods to manipulate data and is especially great with relational or tabular data.</p>

<p>A little while back I started learning Pandas and <a href="http://www.gregreda.com/">Greg Reda&#39;s</a> blog posts <a href="http://www.gregreda.com/2013/01/23/translating-sql-to-pandas-part1/">translating SQL to Pandas</a> helped me a lot in this process. Understanding pandas data structures and methods such as groupby, merge becomes easier once we start comparing them to similar statements in SQL (group by, join). Inspired by Greg&#39;s tutorials I started working on additional exercises for practice. I used assignments from <a href="https://class.coursera.org/db">coursera&#39;s Introduction to databases</a> course and worked out both SQL queries and Pandas methods to solve the questions.</p>

<p>This post covers the <a href="https://class.coursera.org/db/quiz/attempt?quiz_id=128">first assignment</a>.</p>

<h2>SQL Movie-Rating Query Exercises (core set)</h2>

<p>In this part we&#39;ll use a database called &#39;rating&#39;. I downloaded it from the Introduction to databases course in coursera. The database 
has three tables ( &#39;Movie&#39;, &#39;Rating&#39;, &#39;Reviewer&#39; ). The schema is shown below.</p>

<p>Movie table
| mID | title | year | director |</p>

<p>Rating table
| rID | mID | stars | ratingDate |</p>

<p>Reviewer table
| rID | name |</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="c"># set up connections to the DB</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">,</span>\
                        <span class="n">password</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">database</span><span class="o">=</span><span class="s">&#39;rating&#39;</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="c"># set up connections to the DB</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">,</span>\
                        <span class="n">password</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">database</span><span class="o">=</span><span class="s">&#39;rating&#39;</span><span class="p">)</span>
<span class="c">#LOAD the SQL tables into DF</span>
<span class="n">qryMv</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT * From Movie</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="n">qryRt</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT * From Rating</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="n">qryRe</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT * From Reviewer</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="n">movieDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qryMv</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="n">ratDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qryRt</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="n">rvwrDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qryRe</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span></code></pre></div>

<h2>Question-1 : Find the titles of all movies directed by Steven Spielberg.</h2>

<h3>Solution using SQL.</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT title FROM Movie</span>
<span class="s">        WHERE director = &#39;Steven Spielberg&#39;</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
                     <span class="n">title</span>
<span class="mi">0</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>
<span class="mi">1</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>

<span class="p">[</span><span class="mi">2</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">1</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : selection</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="c"># simple selection</span>
<span class="k">print</span> <span class="n">movieDF</span><span class="p">[</span> <span class="n">movieDF</span><span class="p">[</span><span class="s">&#39;director&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Steven Spielberg&#39;</span> <span class="p">][</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
<span class="mi">3</span>                       <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>
<span class="mi">7</span>    <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span></code></pre></div>

<h2>Question-2 : Find all years that have a movie that received a rating of 4 or 5, and sort them in increasing order.</h2>

<h3>Solution using SQL.</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT DISTINCT mv.year FROM Movie mv</span>
<span class="s">        INNER JOIN Rating ra</span>
<span class="s">        ON ra.mID = mv.mID</span>
<span class="s">        WHERE ra.stars &gt;= 4</span>
<span class="s">        ORDER BY mv.year ASC</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
   <span class="n">year</span>
<span class="mi">0</span>  <span class="mi">1937</span>
<span class="mi">1</span>  <span class="mi">1939</span>
<span class="mi">2</span>  <span class="mi">1981</span>
<span class="mi">3</span>  <span class="mi">2009</span>

<span class="p">[</span><span class="mi">4</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">1</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : selection, merge(inner), sort, unique</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="c"># store the ratings in new DF for ease of operation</span>
<span class="c"># we also reset the index.</span>
<span class="n">ratDFNew</span> <span class="o">=</span> <span class="n">ratDF</span><span class="p">[</span> <span class="n">ratDF</span><span class="p">[</span><span class="s">&#39;stars&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c"># Now merge (similar to join in SQL) the new ratingDF</span>
<span class="c"># into the movieDF.</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">ratDFNew</span><span class="p">,</span> <span class="n">movieDF</span><span class="p">,</span> \
                     <span class="n">on</span><span class="o">=</span><span class="s">&#39;mID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span> <span class="p">)</span>
<span class="c"># Now sort according to the year</span>
<span class="c"># note here that we can sort </span>
<span class="c"># the DF in place (using </span>
<span class="c"># the keyword &#39;inplace&#39;) without</span>
<span class="c"># creating a new DF instance.</span>
<span class="n">resDF</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span> <span class="p">)</span>
<span class="c"># get the year column only and </span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">]</span>
<span class="c"># Print the unique values using unique() statement</span>
<span class="k">print</span> <span class="n">resDF</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="p">[</span><span class="mi">1937</span> <span class="mi">1939</span> <span class="mi">1981</span> <span class="mi">2009</span><span class="p">]</span></code></pre></div>

<h2>Question-3 : Find the titles of all movies that have no ratings.</h2>

<h3>Solution using SQL.</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT mv.title FROM Movie mv</span>
<span class="s">        LEFT JOIN Rating ra</span>
<span class="s">        ON ra.mID = mv.mID</span>
<span class="s">        WHERE ra.mID is NULL</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
       <span class="n">title</span>
<span class="mi">0</span>  <span class="n">Star</span> <span class="n">Wars</span>
<span class="mi">1</span>    <span class="n">Titanic</span>

<span class="p">[</span><span class="mi">2</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">1</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : merge(left), isnull</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="c"># We&#39;ll merge the two DFs using</span>
<span class="c"># &#39;left&#39; method. This is like the </span>
<span class="c"># left outer join in SQL.</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">movieDF</span><span class="p">,</span> <span class="n">ratDF</span><span class="p">,</span> \
                     <span class="n">on</span><span class="o">=</span><span class="s">&#39;mID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span> <span class="p">)</span>
<span class="c"># Now retreive &#39;title&#39; column from records</span>
<span class="c">#  which have a Null value in the stars column</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="p">]</span>\
<span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
<span class="k">print</span> <span class="n">resDF</span>
<span class="mi">0</span>    <span class="n">Star</span> <span class="n">Wars</span>
<span class="mi">1</span>      <span class="n">Titanic</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span></code></pre></div>

<h2>Question-4 : Some reviewers didn&#39;t provide a date with their rating. Find the names of all reviewers who have ratings with a NULL value for the date.</h2>

<h3>Solution using SQL.</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT re.name FROM Reviewer re</span>
<span class="s">        INNER JOIN Rating ra</span>
<span class="s">        ON ra.rID = re.rID</span>
<span class="s">        WHERE ra.ratingDate IS NULL</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
            <span class="n">name</span>
<span class="mi">0</span>   <span class="n">Daniel</span> <span class="n">Lewis</span>
<span class="mi">1</span>  <span class="n">Chris</span> <span class="n">Jackson</span>

<span class="p">[</span><span class="mi">2</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">1</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : Methods used : merge(inner), isnull()</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span>  <span class="c"># We&#39;ll merge rvwrDF and ratDF</span>
<span class="c"># and retreive rows which have Null</span>
<span class="c"># in date.</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">rvwrDF</span><span class="p">,</span> <span class="n">ratDF</span><span class="p">,</span> \
                     <span class="n">on</span><span class="o">=</span><span class="s">&#39;rID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span> <span class="p">)</span>
<span class="c"># Now retreive the records which have null</span>
<span class="c"># value in the date column</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;ratingDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="p">]</span>\
<span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
<span class="k">print</span> <span class="n">resDF</span>
<span class="mi">0</span>     <span class="n">Daniel</span> <span class="n">Lewis</span>
<span class="mi">1</span>    <span class="n">Chris</span> <span class="n">Jackson</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span></code></pre></div>

<h2>Question-5 : Write a query to return the ratings data in a more readable format: reviewer name, movie title, stars, and ratingDate. Also, sort the data, first by reviewer name, then by movie title, and lastly by number of stars.</h2>

<h3>Solution using SQL</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT re.name, mv.title, ra.stars, ra.ratingDate</span>
<span class="s">        FROM Movie mv </span>
<span class="s">        INNER JOIN Rating ra ON ra.mID = mv.mID</span>
<span class="s">        INNER JOIN Reviewer re ON ra.rID = re.rID</span>
<span class="s">        ORDER BY re.name, mv.title, ra.stars</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
                <span class="n">name</span>                    <span class="n">title</span>  <span class="n">stars</span>  <span class="n">ratingDate</span>
<span class="mi">0</span>       <span class="n">Ashley</span> <span class="n">White</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>      <span class="mi">3</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">02</span>
<span class="mi">1</span>    <span class="n">Brittany</span> <span class="n">Harris</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>      <span class="mi">2</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">30</span>
<span class="mi">2</span>    <span class="n">Brittany</span> <span class="n">Harris</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>      <span class="mi">4</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span>
<span class="mi">3</span>    <span class="n">Brittany</span> <span class="n">Harris</span>       <span class="n">The</span> <span class="n">Sound</span> <span class="n">of</span> <span class="n">Music</span>      <span class="mi">2</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">20</span>
<span class="mi">4</span>      <span class="n">Chris</span> <span class="n">Jackson</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>      <span class="mi">2</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">22</span>
<span class="mi">5</span>      <span class="n">Chris</span> <span class="n">Jackson</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>      <span class="mi">4</span>        <span class="bp">None</span>
<span class="mi">6</span>      <span class="n">Chris</span> <span class="n">Jackson</span>       <span class="n">The</span> <span class="n">Sound</span> <span class="n">of</span> <span class="n">Music</span>      <span class="mi">3</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">27</span>
<span class="mi">7</span>       <span class="n">Daniel</span> <span class="n">Lewis</span>               <span class="n">Snow</span> <span class="n">White</span>      <span class="mi">4</span>        <span class="bp">None</span>
<span class="mi">8</span>   <span class="n">Elizabeth</span> <span class="n">Thomas</span>                   <span class="n">Avatar</span>      <span class="mi">3</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">15</span>
<span class="mi">9</span>   <span class="n">Elizabeth</span> <span class="n">Thomas</span>               <span class="n">Snow</span> <span class="n">White</span>      <span class="mi">5</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">19</span>
<span class="mi">10</span>     <span class="n">James</span> <span class="n">Cameron</span>                   <span class="n">Avatar</span>      <span class="mi">5</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">20</span>
<span class="mi">11</span>     <span class="n">Mike</span> <span class="n">Anderson</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>      <span class="mi">3</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">09</span>
<span class="mi">12</span>    <span class="n">Sarah</span> <span class="n">Martinez</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>      <span class="mi">2</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">22</span>
<span class="mi">13</span>    <span class="n">Sarah</span> <span class="n">Martinez</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>      <span class="mi">4</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">27</span>

<span class="p">[</span><span class="mi">14</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : merge(inner), sort</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="c"># first merge all the three DFs</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">movieDF</span><span class="p">,</span> <span class="n">ratDF</span><span class="p">,</span> \
                     <span class="n">on</span><span class="o">=</span><span class="s">&#39;mID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span> <span class="p">)</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">resDF</span><span class="p">,</span> <span class="n">rvwrDF</span><span class="p">,</span>\
                     <span class="n">on</span><span class="o">=</span><span class="s">&#39;rID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span><span class="p">)</span>
<span class="c"># sort the DF and select the required columns</span>
<span class="n">resDF</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="s">&#39;stars&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span> <span class="p">)</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span> <span class="p">[</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;stars&#39;</span><span class="p">,</span> <span class="s">&#39;ratingDate&#39;</span> <span class="p">]</span> <span class="p">]</span>\
<span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span> <span class="n">resDF</span>
                <span class="n">name</span>                    <span class="n">title</span>  <span class="n">stars</span>  <span class="n">ratingDate</span>
<span class="mi">0</span>       <span class="n">Ashley</span> <span class="n">White</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>      <span class="mi">3</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">02</span>
<span class="mi">1</span>    <span class="n">Brittany</span> <span class="n">Harris</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>      <span class="mi">2</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">30</span>
<span class="mi">2</span>    <span class="n">Brittany</span> <span class="n">Harris</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>      <span class="mi">4</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span>
<span class="mi">3</span>    <span class="n">Brittany</span> <span class="n">Harris</span>       <span class="n">The</span> <span class="n">Sound</span> <span class="n">of</span> <span class="n">Music</span>      <span class="mi">2</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">20</span>
<span class="mi">4</span>      <span class="n">Chris</span> <span class="n">Jackson</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>      <span class="mi">2</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">22</span>
<span class="mi">5</span>      <span class="n">Chris</span> <span class="n">Jackson</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>      <span class="mi">4</span>        <span class="bp">None</span>
<span class="mi">6</span>      <span class="n">Chris</span> <span class="n">Jackson</span>       <span class="n">The</span> <span class="n">Sound</span> <span class="n">of</span> <span class="n">Music</span>      <span class="mi">3</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">27</span>
<span class="mi">7</span>       <span class="n">Daniel</span> <span class="n">Lewis</span>               <span class="n">Snow</span> <span class="n">White</span>      <span class="mi">4</span>        <span class="bp">None</span>
<span class="mi">8</span>   <span class="n">Elizabeth</span> <span class="n">Thomas</span>                   <span class="n">Avatar</span>      <span class="mi">3</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">15</span>
<span class="mi">9</span>   <span class="n">Elizabeth</span> <span class="n">Thomas</span>               <span class="n">Snow</span> <span class="n">White</span>      <span class="mi">5</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">19</span>
<span class="mi">10</span>     <span class="n">James</span> <span class="n">Cameron</span>                   <span class="n">Avatar</span>      <span class="mi">5</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">20</span>
<span class="mi">11</span>     <span class="n">Mike</span> <span class="n">Anderson</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>      <span class="mi">3</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">09</span>
<span class="mi">12</span>    <span class="n">Sarah</span> <span class="n">Martinez</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>      <span class="mi">2</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">22</span>
<span class="mi">13</span>    <span class="n">Sarah</span> <span class="n">Martinez</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>      <span class="mi">4</span>  <span class="mi">2011</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">27</span>

<span class="p">[</span><span class="mi">14</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h2>Question-6 : For all cases where the same reviewer rated the same movie twice and gave it a higher rating the second time, return the reviewer&#39;s name and the title of the movie.</h2>

<h3>Solution using SQL.</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT re1.name, mv.title FROM Reviewer re1</span>
<span class="s">        INNER JOIN Rating ra1 ON ra1.rID = re1.rID</span>
<span class="s">        INNER JOIN Movie mv ON mv.mID = ra1.mID</span>
<span class="s">        INNER JOIN Rating ra2 ON ra1.rID = ra2.rID AND ra1.mID = ra2.mID</span>
<span class="s">        WHERE ra2.stars &gt; ra1.stars AND ra2.ratingDate &gt; ra1.ratingDate</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
             <span class="n">name</span>               <span class="n">title</span>
<span class="mi">0</span>  <span class="n">Sarah</span> <span class="n">Martinez</span>  <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>

<span class="p">[</span><span class="mi">1</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">2</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : selection, merge(inner,self)</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="c"># merge ratingDF on itself</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">ratDF</span><span class="p">,</span> <span class="n">ratDF</span><span class="p">,</span>\
                     <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;rID&#39;</span><span class="p">,</span><span class="s">&#39;mID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span><span class="p">)</span>
<span class="c"># Note in joins like the self join here, Pandas </span>
<span class="c"># renames columns with same names with _x, _y suffixes.</span>
<span class="c"># Now retreive the rows which satisfy the requirement of</span>
<span class="c"># the question, i.e., stars_y &gt; stars_x and </span>
<span class="c"># ratingDate_y &gt; ratingDate_x.</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span> <span class="p">(</span><span class="n">resDF</span><span class="p">[</span><span class="s">&#39;stars_y&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;stars_x&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
              <span class="p">(</span><span class="n">resDF</span><span class="p">[</span><span class="s">&#39;ratingDate_y&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;ratingDate_x&#39;</span><span class="p">])</span> <span class="p">]</span>
<span class="c"># Now merge the other DFs for required info</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">resDF</span><span class="p">,</span> <span class="n">movieDF</span><span class="p">,</span>\
                     <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;mID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">resDF</span><span class="p">,</span> <span class="n">rvwrDF</span><span class="p">,</span>\
                     <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;rID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span><span class="p">)</span>
<span class="c"># get the required cols</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span> <span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="p">]</span>
<span class="k">print</span> <span class="n">resDF</span>
             <span class="n">name</span>               <span class="n">title</span>
<span class="mi">0</span>  <span class="n">Sarah</span> <span class="n">Martinez</span>  <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>

<span class="p">[</span><span class="mi">1</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">2</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h2>Question-7 : For each movie that has at least one rating, find the highest number of stars that movie received. Return the movie title and number of stars. Sort by movie title.</h2>

<h3>Solution using SQL</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT mv.title, tab.max_stars FROM Movie mv</span>
<span class="s">        INNER JOIN</span>
<span class="s">        (SELECT mID, MAX(stars) max_stars FROM Rating ra</span>
<span class="s">        GROUP BY mID</span>
<span class="s">        HAVING COUNT(mID) &gt; 1) tab</span>
<span class="s">        ON tab.mID = mv.MID</span>
<span class="s">        ORDER BY mv.title</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
                     <span class="n">title</span>  <span class="n">max_stars</span>
<span class="mi">0</span>                   <span class="n">Avatar</span>          <span class="mi">5</span>
<span class="mi">1</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>          <span class="mi">3</span>
<span class="mi">2</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>          <span class="mi">4</span>
<span class="mi">3</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>          <span class="mi">4</span>
<span class="mi">4</span>               <span class="n">Snow</span> <span class="n">White</span>          <span class="mi">5</span>
<span class="mi">5</span>       <span class="n">The</span> <span class="n">Sound</span> <span class="n">of</span> <span class="n">Music</span>          <span class="mi">3</span>

<span class="p">[</span><span class="mi">6</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">2</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : groupby, filter(), merge(inner), rename()</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="c"># Do a groupby operation on ratDF</span>
<span class="n">ratGrps</span> <span class="o">=</span> <span class="n">ratDF</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> <span class="p">[</span><span class="s">&#39;mID&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="c"># we&#39;ll use filter to implement a having type</span>
<span class="c"># operation in pandas, here we&#39;re using filter to</span>
<span class="c"># get all mIDs which have more than 1 rating</span>
<span class="n">ratGrps</span> <span class="o">=</span> <span class="n">ratGrps</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="c"># Now get the rows which have max values in stars</span>
<span class="c"># for the selected mIDs</span>
<span class="n">ratGrpMax</span> <span class="o">=</span> <span class="n">ratGrps</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;mID&#39;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
             <span class="p">[</span><span class="s">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="c"># Merge ratGrpMax with movieDF, before that convert</span>
<span class="c"># the series to dataframe</span>
<span class="n">ratGrpMax</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">ratGrpMax</span> <span class="p">)</span>
<span class="c"># Make index as column with name &#39;mID&#39; for merging</span>
<span class="n">ratGrpMax</span><span class="p">[</span><span class="s">&#39;mID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratGrpMax</span><span class="o">.</span><span class="n">index</span>
<span class="n">ratGrpMax</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c"># Also rename &#39;stars&#39; column to &#39;max_stars&#39;</span>
<span class="n">ratGrpMax</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span> <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;stars&#39;</span><span class="p">:</span><span class="s">&#39;max_stars&#39;</span><span class="p">},</span>\
                 <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span> <span class="p">)</span>
<span class="n">ratGrpMax</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">ratGrpMax</span><span class="p">,</span> <span class="n">movieDF</span><span class="p">,</span>\
                         <span class="n">on</span><span class="o">=</span><span class="s">&#39;mID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span> <span class="p">)</span>
<span class="c"># select the required cols</span>
<span class="n">ratGrpMax</span> <span class="o">=</span> <span class="n">ratGrpMax</span><span class="p">[</span> <span class="p">[</span> <span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;max_stars&#39;</span> <span class="p">]</span> <span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="s">&#39;title&#39;</span> <span class="p">)</span>
<span class="k">print</span> <span class="n">ratGrpMax</span>
                     <span class="n">title</span>  <span class="n">max_stars</span>
<span class="mi">5</span>                   <span class="n">Avatar</span>          <span class="mi">5</span>
<span class="mi">4</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>          <span class="mi">3</span>
<span class="mi">0</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>          <span class="mi">4</span>
<span class="mi">3</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>          <span class="mi">4</span>
<span class="mi">1</span>               <span class="n">Snow</span> <span class="n">White</span>          <span class="mi">5</span>
<span class="mi">2</span>       <span class="n">The</span> <span class="n">Sound</span> <span class="n">of</span> <span class="n">Music</span>          <span class="mi">3</span>

<span class="p">[</span><span class="mi">6</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">2</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h2>Question-8 : For each movie, return the title and the &#39;rating spread&#39;, that is, the difference between highest and lowest ratings given to that movie. Sort by rating spread from highest to lowest, then by movie title.</h2>

<h3>Solution using SQL.</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT mv.title, tab.rat_spread FROM Movie mv</span>
<span class="s">        INNER JOIN</span>
<span class="s">        (SELECT mID, MAX(stars)-MIN(stars) rat_spread FROM Rating ra</span>
<span class="s">        GROUP BY mID)  tab</span>
<span class="s">        ON tab.mID = mv.MID</span>
<span class="s">        ORDER BY tab.rat_spread DESC, mv.title</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
                     <span class="n">title</span>  <span class="n">rat_spread</span>
<span class="mi">0</span>                   <span class="n">Avatar</span>           <span class="mi">2</span>
<span class="mi">1</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>           <span class="mi">2</span>
<span class="mi">2</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>           <span class="mi">2</span>
<span class="mi">3</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>           <span class="mi">1</span>
<span class="mi">4</span>               <span class="n">Snow</span> <span class="n">White</span>           <span class="mi">1</span>
<span class="mi">5</span>       <span class="n">The</span> <span class="n">Sound</span> <span class="n">of</span> <span class="n">Music</span>           <span class="mi">1</span>

<span class="p">[</span><span class="mi">6</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">2</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : groupby, concat, rename, sort</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="c"># Group by mID</span>
<span class="n">ratGrps</span> <span class="o">=</span> <span class="n">ratDF</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> <span class="p">[</span><span class="s">&#39;mID&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="c"># Get max and min star values from groupby ops</span>
<span class="n">ratMax</span> <span class="o">=</span> <span class="n">ratDF</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;mID&#39;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
             <span class="p">[</span><span class="s">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">ratMin</span> <span class="o">=</span> <span class="n">ratDF</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;mID&#39;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
             <span class="p">[</span><span class="s">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="c"># rename the names of ratMin and ratMax Series</span>
<span class="n">ratMax</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;max_stars&#39;</span>
<span class="n">ratMin</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;min_stars&#39;</span>
<span class="c"># merge(concat) the series</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">ratMax</span><span class="p">,</span> <span class="n">ratMin</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
<span class="c"># set the mID col</span>
<span class="n">resDF</span><span class="p">[</span><span class="s">&#39;mID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resDF</span><span class="o">.</span><span class="n">index</span>
<span class="c"># reset the index</span>
<span class="n">resDF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c"># get the rating spread col</span>
<span class="n">resDF</span><span class="p">[</span><span class="s">&#39;rat_spread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;max_stars&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;min_stars&#39;</span><span class="p">]</span>
<span class="c"># merge with movieDF and select req cols</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">resDF</span><span class="p">,</span> <span class="n">movieDF</span><span class="p">,</span>\
                         <span class="n">on</span><span class="o">=</span><span class="s">&#39;mID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span> <span class="p">)</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span> <span class="p">[</span> <span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;rat_spread&#39;</span> <span class="p">]</span> <span class="p">]</span>\
        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s">&#39;rat_spread&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span> <span class="n">resDF</span>
                     <span class="n">title</span>  <span class="n">rat_spread</span>
<span class="mi">0</span>                   <span class="n">Avatar</span>           <span class="mi">2</span>
<span class="mi">1</span>  <span class="n">Raiders</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lost</span> <span class="n">Ark</span>           <span class="mi">2</span>
<span class="mi">2</span>       <span class="n">Gone</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Wind</span>           <span class="mi">2</span>
<span class="mi">3</span>                     <span class="n">E</span><span class="o">.</span><span class="n">T</span><span class="o">.</span>           <span class="mi">1</span>
<span class="mi">4</span>       <span class="n">The</span> <span class="n">Sound</span> <span class="n">of</span> <span class="n">Music</span>           <span class="mi">1</span>
<span class="mi">5</span>               <span class="n">Snow</span> <span class="n">White</span>           <span class="mi">1</span>

<span class="p">[</span><span class="mi">6</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">2</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h2>Question-9 : Find the difference between the average rating of movies released before 1980 and the average rating of movies released after 1980. (Make sure to calculate the average rating for each movie, then the average of those averages for movies before 1980 and movies after. Don&#39;t just calculate the overall average rating before and after 1980.)</h2>

<h3>Solution using SQL.</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="c">#SQL query</span>
<span class="n">qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT MAX(tab2.rat_rel_date) - MIN(tab2.rat_rel_date) difference FROM</span>
<span class="s">        ( SELECT AVG(avg_rat) rat_rel_date FROM</span>
<span class="s">        ( SELECT Movie.mID, AVG(Rating.stars) avg_rat, </span>
<span class="s">        CASE WHEN Movie.year &lt; 1980 THEN &#39;BEFORE&#39; ELSE &#39;AFTER&#39; END rel_date</span>
<span class="s">         FROM Rating</span>
<span class="s">        INNER JOIN Movie ON Movie.mID = Rating.mID</span>
<span class="s">        GROUP BY Movie.mID ) tab</span>
<span class="s">        GROUP BY tab.rel_date) tab2</span>
<span class="s">      &quot;&quot;&quot;</span>
<span class="c"># get the data</span>
<span class="n">qDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span> <span class="n">qry</span><span class="p">,</span> <span class="n">conn</span> <span class="p">)</span>
<span class="c"># print the data</span>
<span class="k">print</span> <span class="n">qDF</span>
   <span class="n">difference</span>
<span class="mi">0</span>    <span class="mf">0.055567</span>

<span class="p">[</span><span class="mi">1</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">1</span> <span class="n">columns</span><span class="p">]</span></code></pre></div>

<h3>Solution using Pandas.</h3>

<blockquote>
<p>Methods used : merge(inner), sort, groupby</p>
</blockquote>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="c"># Merge ratDF and movieDF</span>
<span class="n">resDF</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">movieDF</span><span class="p">,</span> <span class="n">ratDF</span><span class="p">,</span> \
                     <span class="n">on</span><span class="o">=</span><span class="s">&#39;mID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;inner&#39;</span> <span class="p">)</span>
<span class="c"># Now make two new DFs one with movies</span>
<span class="c"># before 1980 and the other after 1980</span>
<span class="n">beforeDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1980</span> <span class="p">]</span>
<span class="n">afterDF</span> <span class="o">=</span> <span class="n">resDF</span><span class="p">[</span> <span class="n">resDF</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1980</span> <span class="p">]</span>
<span class="c"># get average rating for each movie</span>
<span class="n">bfrGrps</span> <span class="o">=</span> <span class="n">beforeDF</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;mID&#39;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
             <span class="p">[</span><span class="s">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">aftrGrps</span> <span class="o">=</span> <span class="n">afterDF</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;mID&#39;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
             <span class="p">[</span><span class="s">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="c"># get the mean of each series and get differences</span>
<span class="k">print</span> <span class="n">bfrGrps</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">aftrGrps</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="mf">0.0555555555556</span></code></pre></div>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  </body>
</html>
